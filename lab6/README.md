# Лабораторная работа №6 - Аутентификация и авторизация

Прототип системы аутентификации и авторизации с ролями, сессиями и многофакторной аутентификацией (MFA).

## Структура файлов

- `register.html` - страница регистрации пользователей
- `login.html` - страница входа в систему
- `authentification.html` - страница подтверждения MFA
- `user.html` - панель пользователя с управлением аккаунтом
- `lab6.js` - основная логика аутентификации (localStorage-based)
- `router.js` - клиентский роутинг для навигации
- `style.css` - стили для всех страниц
- `README.md` - это описание

## Функциональность

### Регистрация
- Хэширование паролей с PBKDF2-SHA-256 + соль (120000 итераций)
- Выбор роли (user/admin)
- Проверка уникальности логина

### Аутентификация
- Вход по логину/паролю с проверкой хэша
- Поддержка MFA (6-значный код, генерируется при каждом входе)
- Управление сессиями (access/refresh tokens с TTL)
- Автоматическое обновление access токена

### Авторизация
- Проверка прав доступа по ролям (user/admin)
- Управление пользователями (для admin)
- Смена пароля (с инвалидацией всех сессий)
- Включение/отключение MFA

### Сессии
- Просмотр активных сессий с временем истечения
- Завершение текущей сессии
- Завершение всех сессий пользователя

## Запуск и тестирование

### Быстрый старт
1. Откройте `http://localhost:8000/` в браузере
2. Нажмите кнопку **«Протестировать»** в блоке «Лабораторная работа 6»

### Ручное тестирование
1. **Регистрация:** `http://localhost:8000/lab6/register.html`
2. **Вход:** `http://localhost:8000/lab6/login.html`
3. **MFA:** `http://localhost:8000/lab6/authentification.html`
4. **Панель:** `http://localhost:8000/lab6/user.html`

### Тестирование MFA
1. Зарегистрируйте пользователя
2. Войдите в панель управления и включите MFA
3. Выйдите из системы
4. Попробуйте войти снова - система сгенерирует 6-значный код
5. Код отображается на странице подтверждения MFA
6. Введите код для завершения входа

### Отладка
- Откройте консоль браузера (F12) для просмотра логов
- На странице MFA есть кнопка "Сгенерировать тестовый код" для проверки отображения

## Архитектура

### Хранение данных
- **localStorage** с ключом `lab6.v1` для базы данных
- **localStorage** с ключом `lab6.v1.current` для текущей сессии
- Данные включают пользователей, сессии и временный MFA код

### Безопасность
- **PBKDF2-SHA-256** для хэширования паролей
- **Случайные соли** для каждого пользователя
- **JWT-подобные токены** для сессий (с HMAC-подписью)
- **Временные ограничения** для MFA кодов (5 минут)

### API
```javascript
// Регистрация
LAB6.register(username, password, role)

// Вход (возвращает 'ok', 'mfa' или ошибку)
LAB6.login(username, password)

// Подтверждение MFA
LAB6.verifyMFA(code)

// Текущая сессия
LAB6.current()

// Обновление access токена
LAB6.refresh()

// Проверка доступа (scope: 'user' | 'admin')
LAB6.call(scope)

// Управление аккаунтом
LAB6.changePassword(oldPass, newPass)
LAB6.setMFA(enabled)
LAB6.setRole(username, role) // только admin

// Сессии
LAB6.listSessions()
LAB6.killCurrent()
LAB6.killAllMine()

// Выход
LAB6.logout()
```

## Технологии

- **HTML5, CSS3** - интерфейс и стили
- **JavaScript (ES6+)** - логика приложения
- **Web Crypto API** - криптографические операции
- **localStorage** - хранение данных
- **Клиентский роутинг** - навигация без перезагрузки

## Особенности реализации

- **Stateless аутентификация** с JWT-подобными токенами
- **Многофакторная аутентификация** с временными кодами
- **Ролевая модель** с проверкой прав доступа
- **Управление сессиями** с возможностью инвалидации
- **Автоматическое обновление токенов** без участия пользователя
- **Отсутствие зависимостей** - чистый JavaScript

## Примечания

- Система использует localStorage, поэтому данные сохраняются только в рамках браузера
- При первом запуске создается администратор с паролем (запрашивается в prompt)
- MFA код генерируется случайно при каждом входе пользователя с включенной MFA
- Сессии имеют ограниченное время жизни (5 мин access, 24 часа refresh)
